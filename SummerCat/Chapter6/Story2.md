# 서버의 수신 동작
## LAN 어댑터에서 수신 신호를 디지털 데이터로 변환

## IP 담당 부분의 수신 동작
1. IP 헤더 점검
   - IP 헤더의 내용이 규칙에 따라 올바르게 만들어 졌는지
   - 수신처 IP 주소가 자신과 일치하는지
   - 조각 나누기(fragmentation)에 의해 패킷이 분할되었는지
     - 분할되어 있는 경우 패킷을 일시적으로 메모리에 저장하고, 분할된 패킷의 조각이 전부 도착한 시점에 조립하여 원래 패킷으로 복원
2. IP 헤더의 포로토콜 번호 항목을 조사해 해당하는 담당 부분(TCP/UDP)에 패킷 전달


## TCP 담당 부분이 접속 패킷을 수신했을 때의 동작
= 패킷의 TCP 헤더의 SYN 컨트롤 비트가 `1`인 경우
1. 도착한 패킷의 수신처 포트 번호를 조사 → 이 번호와 같은 번호를 할당한 접속 대기 상태의 소켓이 있는지 확인
    - 없을 경우, 오류 통지 패킷을 클라이언트에 반송
2. 패킷을 복사하여 새 소켓을 만들고, 송신처 IP 주소, 포트 번호, 시퀀스 번호 초기값, 윈도우 값 등 필요한 정보 기록, 버퍼 메모리 영역 확보
3. TCP 헤더를 만들어 IP 담당 부분에 의뢰하여 클라이언트에 반송
   - TCP 헤더에는 ACK 번호, 시퀀스 번호 초기값, 윈도우 값 등이 포함
4. 해당 패킷을 클라이언트에서 수신 후 반송한 ACK 번호가 도착하면 접속 동작 완료

이 때 서버 측 애플리케이션은 `accept`를 호출하여 실행을 쉬는 상태이다.
새로 만든 소켓의 디스크립터를 전달하여 서버 애플리케이션의 동작을 재개한다.

## TCP 담당 부분이 데이터 패킷을 수신했을 때의 동작
1. IP 헤더의 송신처/수신처 IP 주소, TCP 헤더의 송신처/수신처 포트 번호 4가지 정보가 모두 합치되는 소켓을 찾는다.
2. 해당 소켓을 발견하면 패킷에 기록된 데이터 송수신 진행상황과 도착한 패킷의 TCP 헤더 정보를 결합하여 데이터 송수신 동작이 올바르게 진행되고 있는지 점검
   - 소켓에 기록된 시퀀스 번호와 데이터 조각 길이를 이용해 도착핸 패킷의 시퀀스 번호와 합치하는지 조사
3. 수신한 데이터를 수신 버퍼에 저장
4. 수신 확인 응답용 TCP 헤더 작성
   - 수신 패킷의 시퀀스 번호, ACK 번호를 기록
5. IP 담당 부분에 의뢰하여 클라이언트에 반송

## TCP 담당 부분의 연결 끊기 동작
서버/클라이언트 중 어느 쪽이 먼저 연결 끊기 동작에 들어가는지는 애플리케이션이 결정한다.
  - 웹의 경우 HTTP 1.0이면 서버에서 연결 끊기 동작을 시작
  - HTTP 1.1의 경우 클라이언트에서 먼저 연결 끊기 동작을 시작할 수 있다.

1. 서버 측 애플리케이션이 Socket 라이브러리의 `close` 호출
2. TCP 담당 부분이 FIN 컨트롤 비트에 `1`을 설정한 TCP 헤더를 만듦
3. IP 담당 부분에 의뢰하여 클라이언트에 전송
4. 클라이언트가 수신 후 ACK 번호 반송
5. 클라이언트가 `close`를 호출
6. 클라이언트가 FIN을 `1`로 설정한 TCP 헤더를 서버에 보냄
7. 서버가 ACK 번호를 반송하면 연결 끊기 동작 완료
8. 연결 끊기 동작이 완료되면 잠시 기다렸다가 소켓을 말소
