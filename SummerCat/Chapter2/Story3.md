# 데이터를 송수신한다

소켓이 연결되면 제어가 애플리케이션으로 넘어가서 데이터 송수신 동작을 시작

## 데이터 송수신
1. 애플리케이션이 `write`를 호출해 송신 데이터를 프로토콜 스택에 전달
2. 프로토콜 스택 내부의 송신용 버퍼 메모리 영역에 받은 데이터 저장
3. 송신 버퍼의 데이터를 분할해서 패킷에 넣어 송신
   - 패킷 맨 앞부분에 TCP 헤더를 추가
   - TCP 헤더에는 소켓에 기록된 제어 정보를 바탕으로 송수신처 포트번호 등을 기록
4. IP 담당 부분에 패킷을 전달해 송신 동작 실행
   - 패킷이 서버를 향해 송신

## 패킷 도착 확인

TCP에는 송신한 패킷이 상대에게 올바르게 도착했는지 확인하고, 도착하지 않았으면 다시 송신하는 기능이 있다.

TCP 헤더에 기록한 **시퀀스 번호**를 활용해 수신 측에서 패킷 누락 확인
  - 누락이 없으면 수신 측에서 TCP 헤더에 ACK 번호를 기록해 송신 측에 알림
  - 수신 확인 응답 = ACK 번호를 되돌려주는 동작

### 도착 확인 프로세스
1. 접속 동작을 실행할 때, 클라이언트가 서버에 시퀀스 번호 초기값을 통지
2. 서버에서 초기값으로부터 ACK 번호를 산출하여 클라이언트에 반송
   - 서버 → 클라이언트 데이터의 시퀀스 번호 초기값도 클라이언트에 함께 통지
3. 클라이언트 → 서버 ACK 번호를 서버에 반송
   - 양 측이 시퀀스 번호, ACK 번호가 준비되었으므로 데이터 송수신 동작 시작
5. 클라이언트 → 서버 메시지 보냄
   - 보내는 패킷의 TCP 헤더에 시퀀스 번호가 포함
6. 데이터를 수신한 서버에서 ACK 번호 반송

TCP는 상대가 데이터를 수신한 것을 확인할 때까지 송신한 패킷을 버퍼 메모리 영역에 보관한다.
  - 미수신 시 재전송
  - LAN 어댑터, 버퍼, 라우터 등에서 데이터 전송 오류를 회복 조치 할 필요가 없다.
  - 여러 번 보내도 상대에 도착하지 못하면 송신 동작을 강제로 종료하고 애플리케이션에 오류 통지

## 윈도우 제어

차례대로 연속해서 복수의 패킷을 보내는 방법
  - 패킷을 하나 보내고 그에 대한 ACK 번호가 돌아올 때까지 기다리지 않는다.
  - 수신 측의 수신 버퍼 크기 이상으로 패킷이 도착하면 오류가 발생할 수 있으므로, 수신 측에서 미리 송신 측에 **윈도우 사이즈**를 통지
  - 수신 측에서 수신 처리가 끝나 수신 버퍼에 빈 부부이 생기면, TCP 헤더의 윈도우 필드에 **윈도우 값**으로 송신측에 알림
  - ACK 번호와 윈도우 통지는 연속된 경우, 중간은 생략하고 마지막 것만 보내서 패킷을 줄인다. (계속 보내면 비효율적이니까)

## HTTP 응답 메시지 수신

1. 애플리케이션이 서버에서 돌아오는 응답 메시지를 받기 위해 `read` 호출
2. 프로토콜 스택이 수신 버퍼에서 수신 데이터를 추출하여 애플리케이션에 전달
   - 아직 응답 메시지가 돌아오지 않았다면 작업을 잠시 보류
3. 수신한 데이터 조각과 TCP 헤더의 내용을 조사해 데이터 누락 검사
   - 문제가 없으면 ACK 번호 반송
4. 데이터 조각을 수신 버퍼에 일시적으로 보관
5. 조각을 연결해 원래대로 복원한 데이터를 애플리케이션이 지정한 메모리 영역에 기록
6. 송신측에 윈도우 통지
