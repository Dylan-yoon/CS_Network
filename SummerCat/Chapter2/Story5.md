# IP와 이더넷의 패킷 송수신 동작
TCP 담당 부분이 IP 담당 부분에 의뢰하여 데이터를 패킷으로 만든다.

## 패킷
패킷: 데이터와 헤더로 구성

<img width="430" alt="image" src="https://github.com/Dylan-yoon/CS_Network/assets/98260324/d7c5b2e2-5903-4052-ac64-5f9e0418c8a8">

  - 헤더: 제어 정보를 포함
    - IP 헤더: 송수신처 IP 주소, 프로토콜 번호 등이 기록되어 있음
      - IP 헤더의 수신처는 바뀌지 않는다.
      - 프로토콜 번호: TCP/UDP/ICMP 중 어디서 의뢰한 것인지 나타내는 값
    - MAC 헤더: 송수신처 MAC 주소, 이더 타입이 기록되어 있음
      - MAC 헤더의 수신처는 다음 라우터로 계속 변경된다.
      - 이더 타입: 패킷의 내용물이 IP/ARP의 소켓 중 무엇인지 나타내는 값.
        - IP 프로토콜은 0800, ARP 프로토콜은 0806
        - ARP: 상대의 MAC 주소를 조사, 조사 결과를 ARP 캐시에 저장

### 패킷의 전송
1. 송신처에서 패킷 생성
2. 가장 가까운 중계 장치에 패킷 송신
3. 중계 장치가 패킷 헤더를 조사해 패킷의 목적지를 판단
4. 목적지를 향해 중계 장치들을 거쳐 수신처에 도달
   - 엔드 노드: 수신처/송신처 기기
   - 중계 노드(중간 노드): 중계 장치

## 패킷 송수신 동작
- 프로토콜 스택의 IP 담당 부분은 패킷을 상대에게 송출만
- 패킷 운반은 허브나 라우터 같은 네트워크 기기의 역할

1. TCP 담당 부분이 IP 담당 부분에 패킷 송신 의뢰
   - 데이터에 TCP 헤더를 추가해서 전달
2. IP 담당 부분에서 IP 헤더와 MAC 헤더를 추가
   - TCP 헤더와 데이터를 한 덩어리의 바이너리 데이터로 간주하고 내용을 확인하지 않고 송수신 동작을 실행
4. 만든 패킷을 네트워크용 하드웨어(LAN 어댑터)에 전달
   - LAN 어댑터에 건네줄 때의 패킷은 0과 1로 이루어진 디지털 데이터
5. LAN 어댑터가 데이터를 전기/빛 신호로 바꾸어 케이블에 송출
6. 신호가 중계 장치(허브, 라우터 등)에 도착
7. 중계 장치가 목적지까지 패킷 전달
8. 도착하면 1~6을 역순으로 실행

## 이더넷
- 다수의 컴퓨텉가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 통신 기술

이더넷 패킷의 송수신 동작
  - IP가 만든 패킷은 디지털 데이터이므로, 전기/빛 신호로 변환하여 네트워크 케이블에 송출
  - LAN 드라이버(소프트웨어)가 LAN 어댑터(하드웨어)를 제어

1. IP 담당 부분에서 패킷을 받으면 LAN 드라이버가 LAN 어댑터의 버퍼 메모리에 복사
2. 복사를 마치면 패킷을 송신하도록 MAC 회로에 명령
3. MAC 회로가 송신 패킷을 버퍼 메모리에서 추출
   - 맨 앞에는 프리앰블, 스타트 프레임 딜리미터 추가
   - 맨 끝에는 프레임 체크 시퀀스(FCS) 추가
4. 신호 송신
   1. MAC 회로가 맨 앞부터 1비트씩 디지털 데이터를 전기 신호로 변환
   2. PHY 또는 MAU 라는 송수신 신호 부분에 보냄
   3. PHY/MAC 회로가 신호를 케이블에 송출하는 형식으로 변환하여 송신
5. 신호 수신
   1. PHY/MAU 회로에서 신호를 공통 형식으로 변환해 MAU 회로에 보냄
   2. MAC 회로에서 신호를 맨 앞부터 디지털 데이터로 변환하여 버퍼 메모리에 저장
   3. 신호 맨 끝의 FCS를 검사해 오류 패킷 여부 판별
   4. MAC 헤더의 수신처 MAC 주소 확인 (자신이 맞는지)
   5. 패킷을 버퍼 메모리에 저장 후 컴퓨터 본체에 인터럽트로 패킷 수신 사실 통지
6. LAN 드라이버가 TCP/IP의 프로토콜 스택에 패킷 전달
   1. IP 담당 부분은 IP 헤더와 수신처 IP 주소 검증
      - 오류(자신의 IP 주소와 불일치)가 발생하면 ICMP 메시지를 사용해 상대에게 오류 통지
  2. 분할된 패킷이 모두 도착하면 IP 담당 부분이 원래 모습으로 되돌림(리어셈블링)
  3. 리어셈블링이 끝나면 패킷을 TCP 담당 부분에 전달
  4. TCP 헤더를 조사해 소켓을 찾음
  5. 소켓에 기록된 통신 진행 상태에 따라 적절한 동작 실행
     - 데이터 패킷이면 수신 확인 패킷 반송 후 데이터를 수신 버퍼에 저장
     - 접속/연결 끊기 패킷이면 응답하는 제어용 패킷을 반송하거나, 접속/연결 끊기 동작 상황을 애플리케이션에 통지
