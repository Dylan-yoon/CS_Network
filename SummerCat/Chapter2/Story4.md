# 서버에서 연결을 끊어 소켓을 말소한다

## 연결 끊기 단계

데이터 송신을 완료한 측이 연결 끊기 단계에 들어간다.

(서버 측이 먼저 연결 끊기 단계에 들어간 경우)

1. 서버 측 애플리케이션이 `close` 호출
2. 서버 측 프로토콜 스택이 TCP 헤더를 생성하고, 헤더의 FIN 비트를 1로 설정
3. 서버 측 IP 담당 부분에 의뢰해 클라이언트에 송신, 서버 측 소켓에 연결 끊기 동작에 들어갔다는 정보 기록
4. 클라이언트 측에 FIN이 1인 TCP 헤더 도착
5. 클라이언트 측 프로토콜 스택이 소켓에 서버 측이 연결 끊기 동작에 들어갔다는 것을 기록
6. FIN이 1인 패킷을 받은 사실을 서버 측에 ACK 번호를 반송해서 알림
7. 클라이언트 측 애플리케이션이 `read` 호출
8. 서버에서 보낸 데이터를 전부 수신 완료했다는 사실을 클라이언트 측 애플리케이션에 알림
9. 클라이언트 측 애플리케이션이 `close`를 호출하여 데이터 송수신 동작을 끝냄
10. 클라이언트 측 프로토콜 스택에서 FIN 비트가 1인 TCP 헤더를 작성해 IP 담당 부분에 의뢰하여 서버에 송신
11. 서버로부터 ACK 번호가 돌아오면 끝
12. 서버와의 대화가 끝나면 잠시 기다린 후 소켓 말소 (오동작을 막기 위해)


## 데이터 송수신 동작 요약
1. 소켓 작성
   1. 서버 측에서 소켓을 작성하고 접속 대기 상태로 만든다.
   2. 사용자가 서버에 액세스하는 동작을 취하면 클라이언트 측에서 패킷 작성
   3. 클라이언트 측 소켓 작성
2. 접속 동작 (클라이언트 → 서버)
   1. 클라이언트 → 서버 TCP 헤더 전송
      - SYN 비트가 1
      - 시퀀스 번호 초기값, 윈도우 값 포함
    2. 서버에 도착하면 서버 → 클라이언트 TCP 헤더 전송
       - SYN 비트가 1
       - 시퀀스 번호 초기값, 윈도우 값, ACK 번호 포함
    3. 클라이언트에 도착하면 클라이언트 → 서버 TCP 헤더 전송
       - ACK 번호 포함
3. 데이터 송수신
   1. 클라이언트 → 서버 리퀘스트 메시지를 TCP가 분할, TCP 헤더를 맨 앞에 추가해 전송
      - 시퀀스 번호 포함
    2. 서버에 도착하면 서버 → 클라이언트 ACK 번호 반송, 윈도우 값 통지
    3. 서버 → 클라이언트 응답 메시지 전송
4. 연결 끊기
   1. 서버 → 클라이언트 TCP 헤더 전송
      - FIN 비트가 1
    2. 클라이언트에 도착하면 클라이언트 → 서버 TCP 헤더 전송
       - ACK 번호 포함
    3. 클라이언트 → 서버 TCP 헤더 전송
       - FIN 비트가 1
    4. 서버에 도착하면 서버 → 클아이언트 TCP 헤더 전송
       - ACK 번호 포함
    5. 소켓 말소
