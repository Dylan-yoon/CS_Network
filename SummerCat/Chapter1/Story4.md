# 프로토콜 스택에 메시지 송신을 의뢰한다

### 데이터 송수신 동작
- IP 주소를 조사한 후, IP 주소의 상대에 메시지를 송신하도록 애플리케이션이 OS 내부의 프로토콜 스택에 의뢰한다.

1. 소켓 작성 단계
  - 양 끝(데이터를 송수신하는 컴퓨터)에 소켓을 만든다.
    - 소켓: 데이터의 출입구
    - Socket 라이브러리의 `socket`을 호출
    - 소켓이 생기면 `디스크립터`가 애플리케이션에 돌아온다.
      - 디스크립터: 소켓을 식별하기 위해 사용 (동시에 여러 데이터 송수신 동작이 존재할 수 있으므로)
      - 애플리케이션은 디스크립터를 메모리에 기록
2. 접속 단계
  - 만든 소켓을 서버측의 소켓에 접속하도록 프로토콜 스택에 의뢰 (Socket 라이브러리의 `connect` 호출)
    - `connect` 호출 시, `디스크립터`, `서버의 IP 주소`, `포트 번호`를 지정
      - 프로토콜 스택은 디스크립터를 보고 어느 소켓을 서버 측의 소켓에 접속시킬지 판단하여 접속 실행
      - IP 주소만으로는 상대측 컴퓨터(서버)의 어느 소켓인지까지는 알 수 없다.
      - 포트 번호: 접속 상대측에서 소켓을 식별하기 위해 사용. 서버측의 포트 번호는 애플리케이션 종류에 따라 미리 지정된 것을 사용.
      - 클라이언트측 소켓의 포트 번호는 소켓을 만들 때 프로토콜 스택이 할당, 프로토콜 스택이 접속 동작을 실행할 때 이 값을 서버측에 통지

3. 송수신 단계
  - 애플리케이션이 송신 데이터(HTTP 리퀘스트 메시지)를 메모리에 준비
  - Socket 라이브러리의 `write` 호출
    - 디스크립터와 송신 데이터를 지정
  - 프로토콜 스택이 송신 데이터를 서버에 송신
    - 소켓에는 연결된 상대가 기록되어 있으므로, 디스크립터로 소켓을 지정하면 그 소켓과 연결된 상대에 데이터를 송신
  - 네트워크를 통해 송신 데이터가 액세스 대상 서버에 도착
  - 서버가 수신 동작 실행
    - 받은 데이터의 내용을 조사해 적절한 처리를 실행한 후 응답 메시지 반송
  - Socket 라이브러리의 `read`를 통해 돌아온 메시지의 수신 동작을 프로토콜 스택에 의뢰
    - 이 때 수신한 메시지를 저장하기 위한 메모리 영역(수신 버퍼)을 지정
    - 메시지가 돌아오면 `read`가 받아서 수신 버퍼에 저장
  - 수신 버퍼에 저장된 메시지에 애플리케이션이 접근

4. 연결 끊기 단계
  - 서버에서 응답 메시지의 송신을 완료하면 서버측에서 `close`를 호출하여 연결을 끊는다.
  - 클라이언트측에 전달되어 클라이언트의 소켓이 연결 끊기 단계로 들어간다.
  - 애플리케이션이 `read`로 수신 동작을 의뢰했을 때, `read`는 수신한 데이터를 건네주는 대신 송수신 동작이 완료되어 연결이 끊겼다는 것을 애플리케이션에 통지
  - 애플리케이션이 송수신 종료를 인지하고 `close` 호출
