# 05. IP와 이더넷의 패킷 송.수신 동작

### 1. 패킷의 기본

---

- TCP 담당부분은 접속, 송.수신, 연결끊기의 각 단계에서 통신 상대와 대화할 때 IP 담당 부분에 의뢰한다.

의뢰를 받은 IP 담당부분이 어떻게 패킷을 상대에게 송신할까?

- 패킷 = 헤더 + 데이터
    - 헤더에는 수신처를 나타내는 주소 등의 제어정보가 있다.
- 패킷을 만든 후, 가장 가까운 중계장치로 보낸다. (중계장치 내부에 수신처에 대한 정보 기록표를 보고 판단 알아서한다.)
- 송신처와 수신처의 기기를 묶어 “엔드 노드”라고 한다.

<img width="1219" alt="스크린샷 2023-08-12 오후 2 17 28" src="https://github.com/Dylan-yoon/CS_Network/assets/59204352/59c1ec2d-4083-4db3-b44e-740449fd18f2">


### 2. 패킷 송.수신 동작의 개요

---

IP담당 부분은 패킷을 상대에게 송출만 하기 때문에 그 뒤에 상대가 있는 곳까지 패킷을 운반하는 것은 허브나 라우터 같은 네트워크 기기의 역할이다.

- **IP담당 부분에서** 내용물 앞에 두개의 헤더를 추가한다.
    - **“IP헤더”와 “MAC헤더”**
    - IP헤더 : IP프로토콜에 규정된 규칙에 따라 **IP 주소로 표시된 목적지까지** 패킷을 전달할 때 사용하는 제어 정보를 기록한 것이다.
    - MAC헤더 : 이더넷 등의 LAN을 사용하여 **가장 가까운 라우터까지** 패킷을 운반할 때 사용한 제어정보를 기록한 것이다.
    - (TCP헤더는 상대측에게 보내는 부가적인 제어정보)

- 이렇게 만든 패킷을 네트워크용 하드웨어에게 전달한다.
    - 이더넷, 무선 LAN과 같은 하드웨어 → LAN 어댑터
    - LAN 어댑터에 건네줄때의 패킷은 0, 1의 비트가 이어진 디지털 데이터의 모습이다.
- 그리고 이진 디지털 데이터가 LAN 어댑터에 의해 전기나 빛의 신호 상태로 바뀌어 케이블에 송출된다.
- 신호는 허브나 라우터등의 중계장치에 도착하고, 중계 장치에서 상대가 있는 곳까지 패킷을 전달한다.

- 반대는 LAN 어배터에서 디지털데이터의 모습으로 바뀌고 디지털 데이터의 패킷을 IP 담당에게 되돌려 준다.

### 3. 수신처 IP 주소를 기록한 IP  헤더를 만든다.

---

- IP 담당 부분은 TCP 담당 부분에서 패킷 송.수신 의뢰를 받으면 IP 헤더를 만들어 TCP의 헤더의 앞에 붙입니다.
- IP는 스스로 수신처를 판단하지 않고 애플리케이션이 지정한 상대에게 패킷을 송신할 뿐이므로 애플리케이션이 IP주소를 잘못 지정해도 그 IP주소를 그대로 IP헤더에 설정한다.
- 서버 기계 등에서 복수의 LAN 어댑터를 장착할 수 있는데, 이때 한대의 컴퓨터에서 할당된 IP주소가 여러개 이므로 어느 IP주소를 설정해야할지 판단해야한다.
    - LAN 어댑터가 결정되면 IP주소가 결정된다.

### 4. 이더넷용 MAC헤더를 만든다.

---

- IP헤더를 만들었으면 IP 담당 부분의 앞에 MAC 헤더를 붙인다.
    - 수신처 MAC 주소 : 패킷을 전달하는 상대의 MAC 주소
    - 송신처 MAC 주소 : 패킷을 송신한 측의 MAC 주소
    - 이더 타입 : 사용하는 프로토콜의 종류를 나타낸다.
- 패킷을 건내줄때는 경로표를 보고 기록한다.
    - 하지만 이 시점에서 상대의 MAC주소를 모르기 때문에 조사하는 동작을 실행한다.

### 5. ARP로 수신처 라우터의 MAC 주소를 조사한다.

---

- 이더넷에는 연결되어있는 전원에게 패킷을 전달하는 브로드캐스트 구조가 있다.
- ARP의 개념 : 브로드캐스트 구조를 이용하여 전원에게 질문해서 응답 값을 받는 방식
    - ARP를 한번 사용하면 ARP 캐시라는 메모리 영역에 보존하여 다시 이용한다.

### 6. 이더넷의 기본

---

**이더넷 : 다수의 컴퓨터가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 통신 기술이다.**

1. 이더넷의 원형 - 케이블 이용
    - 케이블을 통해 신호가 전체에 흐른다.
    - 한곳에서 송신하면 모든 기기가 수신하지만 앞의 헤더에 기재된 수신처 주소와 비교하여 수신처 주소와 다른 곳은 패킷을 폐기한다.
2. 파생형 - 리피터 허브
    - 허브를 통해 신호가 흐른다.
    - 여전히 전체가 수신받는다.
3. 파생형 2 - 스위칭허브
    - 수신처 MAC 주소에 따라 목적지 확인하고 패킷을 중계하므로, 원하는 수신처에게만 패킷이 전달된다.
    - (다른 곳에는 수신이 되지않는다.)


<img width="729" alt="스크린샷 2023-08-12 오후 2 17 42" src="https://github.com/Dylan-yoon/CS_Network/assets/59204352/fc9b8d1a-82f3-45d6-bcb4-e790ce203940">


### 7. IP 패킷을 전기나 빛의 신호로 변환하여 송신

---

- IP가 만든 패킷은 메모리에 기억된 디지털 데이터이므로 이것을 그대로 상대에게 보낼 수 없다.
- 그래서 디지털 데이터를 전기나 빛의 신호로 변환하여 네트워크 케이블에 송출한다.

### 8. 패킷에 3개의 제어용 데이터를 추가한다.

---

패킷을 전기 신호로 변환하여 실제로 케이블에 송출한다.

LAN 드라이버는 IP담당 부분에서 패킷을 받으면 그것을 LAN어댑터의 버퍼 메모리에 복사한다.

- MAC 회로는 먼저 송신 패킷을 버퍼 메모리에서 추출하고 맨앞에는 프리앰블, 스타트프레임 딜리미터라는 두개의 데이터, 프레임 체크 시퀀스라는 오류 검출용 데이터를 부가한다.
- 디지털 데이터를 전기 신호로 보낼 때는 0과 1의 비트값을 전압이나 전류의 값에 대응시킨다.
- 비트 구분을 **클록**이라는 신호로 구분한다.

프리앰블 : 클록신호의 타이밍을 잡는 신호

스타트 프레임 딜리미터 : 패킷의 시작을 나타내는 표시

FCS : 패킷 운반 도중 유실되는 데이터를 검출하기 위해 사용

### 9. 허브를 향해 패킷을 송신한다.

---

- 프리앰블, 스타트 프레임 딜리미터, FCS의 세 가지를 부가하면 케이블에 송출하는 패킷이 완성된다.
- 만약 서로의 신호가 뒤섞이면 충돌이라는 현상이 발생하고, 재밍신호를 보낸다.

### 10. 돌아온 패킷을 받는다.

---

신호의 맨앞에는 프리앰블이 있으므로 파형의 타이밍을 계산한다.

스타트 프레임 딜리미터가 나오면 그 다음 비트부터 디지털 데이터로 변환하여 동작한다

신호의 마지막에 이르면 맨 끝의 FCS를 검사한다.

- MAC회로가 할일이 끝나면 패킷을 수신한 사실을 컴퓨터 본체에게 **인터럽트**를 통해 통지한다.

### 11. 서버의 응답 패킷을 IP에서 TCP로 넘긴다.

---

- 수신된 패킷의 프로토콜의 종류를 LAN드라이버가 MAX헤더의 타입필드 값으로 판별한다.
    - 0800 : TCP/IP

- 서버에서 송신된 패킷의 타입은 0800이므로 LAN드라이버는 TCP/IP의 프로토콜 스택에 패킷을 건넨다.
- IP담당부분은 받은 패킷의 수신처IP주소를 확인하고 일치하는지 확인 한다.
- 패킷을 짧게하기 위해 패킷을 여러개로 분할한다.(프래그맨테이션)
    - 프래그먼트 오프셋이라는 항목에는 원래 패킷이 어느위치에있는지 알려주는 정보가 있다.
- 패킷이 전부 도착하면 패킷을 원래 모습으로 되돌리는 리어셈블링 과정을 거친다.

리어셈블링이 끝나면 패킷을 TCP 담당에게 건네준다.
