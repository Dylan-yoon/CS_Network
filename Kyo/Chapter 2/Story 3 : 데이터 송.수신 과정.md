# 03. 데이터 송.수신 과정

### 📌 프로토콜 스택에 HTTP 리퀘스트 메세지를 넘긴다.

- `connect`에서 애플리케이션에 제어 신호가 되돌아오면 데이터 송.수신 동작으로 들어간다.
- `write`를 호출하여 송신데이터를 프로토콜 스택에 전달해주는 것부터 시작한다.

**여기서 프로토콜 스택의 동작**

- 받은 데이터를 곧 바로 송신하지 않고, 일단 자체 내부에 있는 송신용 버퍼 메모리 영역에 저장하고,
- 애플리케이션이 다음 데이터를 건네주기를 기다린다.

→ 만약 주는 족족 송신하면 작은 패킷을 정말 많이 보낼 수 도 있다. 그러면 네트워크 이용 효율이 저하된다.

→ 그래서 어느 정도 데이터가 쌓이면 송.수신 동작을 수행한다.

**그러면 어느 정도 데이터가 쌓인 것을 어떻게 판단하나?**

1. **MTU**를 기준으로 판단한다.
    - MTU : 한 패킷으로 운반할 수 있는 디지털 데이터의 최대 길이이다.
    - MTU는 패킷의 제일 앞 헤더가 포함되고 헤더를 제외한 하나의 패킷으로 운반할 수 있는 데이터의 최대 길이이다. 이것을 **MSS**라고 한다.
    - 애플리케이션에서 받은 데이터가 MSS를 초과하거나 MSS에 가까운 길이에 이르기까지 데이터를 저장하고 송신 동작을 한다.
    
    (그래서 헤더가 길어질 수 록 MSS는 짧아진다.)(이더넷의 경우 MTU는 1500바이트이다.)
    

<img width="1391" alt="스크린샷 2023-08-06 오후 4 39 15" src="https://github.com/Dylan-yoon/CS_Network/assets/59204352/1e3d794b-dcaa-4d8b-a447-7966268ff24e">


1. 타이밍을 기준으로 판단한다.
    - 애플리케이션의 송신 속도가 느려질 때, MSS에 가깝게 데이터를 저장하면 송신동작에 지연이 발생한다.
    - 데이터가 모이지 않아도 송신동작을 해야할 때가 있다.
    - **프로토콜 스택 내부에 타이머가 있어서 일정 시간 경과시 패킷을 전송한다.**

결론 두가지를 절충해야한다.
<br></br>
### 📌 데이터가 클 때는 분할한다.

- 폼을 사용한 긴 데이터를 보낼 경우 한 패킷에 들어가지 않을 만큼 길 수 도 있다.
- 이 경우 데이터의 길이가 MSS의 길이를 초과하므로 MSS의 크기에 맞게 분할하고 한 패킷씩 송신한다.
<br></br>
### 📌 ACK 번호를 사용하여 패킷의 도착을 확인한다.

- TCP에는 송신한 패킷이 상대측에 잘 도착했는지, 미도착할 경우 다시 송신하는 기능이 있다.
- 데이터를 조각으로 분리해서 송신할때, 몇번째 바이트에 해당하는지 세고 이를 TCP헤더에 기록한다. 
→ 시퀀스 번호
- ACK번호는 그 이전에 수신한 데이터를 합쳐서 몇 번째 바이트까지 수신했는지 계산해서 기록한 번호이다.
(즉, 나 여기까지 받았어 라는 번호)
    - 이 ACK번호를 되돌려주는 동작을 수신 확인 응답이라고도 한다.)

- 실제로 시퀀스 번호는 난수를 바탕으로 한다.(해킹 우려)
- 그래서 초기값만 상대에게 알려준다.

<img width="1226" alt="스크린샷 2023-08-06 오후 4 39 29" src="https://github.com/Dylan-yoon/CS_Network/assets/59204352/ee438a0a-a7cd-4d93-a2e4-1fa85e88731e">

### 패킷 평균 왕복 시간으로 ACK 번호의 대기 시간을 조정한다.

만약 네트워크가 좋지 않을때도 있고, 좋을 때도 있다면?

- 대기 시간이 너무길면 패킷을 다시보내야하는데 이 대기시간이 들쭉날쭉할 경우가 있다.
- 대기시간을 동적으로 변경하는 방법을 취한다.
    - ACK번호가 돌아오는 시간이 지연되면 늘리고, 짧으면 줄인다.
<br></br>
### 📌 윈도우 제어 방식으로 효율적인 ACK 번호를 관리한다.

ACK 번호가 돌아올 때 까지 아무일도 안하는 것은 낭비다.

- 그래서 일단 다음 패킷을 쭉쭉 보내놓는다.
- 수신(받는) 측의 TCP 는 패킷을 수신하면 일단 수신용 버퍼 메모리에 데이터를 임시 보관한다.
- 근데 데이터가 버퍼에서 넘칠 수 도 있으니, 수신 가능한 데이터 양을 함께 보낸다.
    - 수신 가능한 데이터양의 최댓값을 윈도우 사이즈라고 한다.
<br></br>
### 📌 ACK 번호와 윈도우를 합승한다.

송.수신 동작의 효율성을 높이기 위해서 ACK 번호와 윈도우를 통지하는 타이밍을 고려해야한다.

- 수신측에서 애플리케이션에 데이터를 건네주고 수신 버퍼의 빈 영역이 늘어났을 때, 이것을 송신측에 통지해야하는데, 이게 윈도우 통지 타이밍이다.
<br></br>
### 📌 HTTP 응답 메세지를 수신한다.

- 서버에서 돌아오는 응답 메세지를 받기 위해 `read`를 호출한다.
