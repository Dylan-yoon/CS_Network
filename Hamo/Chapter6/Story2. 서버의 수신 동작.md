# Story2. 서버의 수신 동작
## LAN 어댑터에서 수신 신호를 디지털 데이터로 변환한다.

2장에서 클라이언트의 패킷 수신 동작에서 설명한거랑 비슷함

- CPU는 패킷의 도착을 감시하고 있는 것이 아니라 인터럽트라는 방법을 통해서 알림을 받는다.
    - 이 시점에서 CPU는 실행하던 작업을 중단하고 LAN 드라이버로 실행을 전환한다.

## IP 담당 부분의 수신 동작

- 수신처 IP 자신을 대상으로 하는지 조사한다.
- 자신을 대상으로 하지 않은 패킷이 도착할 수 있다.
    - 중계 대상을 조사해서 그것에 패킷을 중계한다.
- 패킷이 분할되었는지 조사한다.
    - 분할되어 있다면 일시적으로 메모리에 저장해두고 전부 도착하면 조립해서 원래 상태로 복원한다.
- 프로토콜 번호 항목을 조사하여 해당하는 담당 부분에 패킷을 건네준다.
    - 06 → TCP
    - 11 → UDP
- 요약
    - IP 헤더를 점검하고 자신을 대상으로 한것인지 판단한 후 조각 나누기에 의한 패킷의 분할이 있는지 조사하고 TCP 담당 부분 또는 UDP 담당 부분에 패킷을 건네준다.

## TCP 담당 부분이 접속 패킷을 수신했을 때의 동작

- TCP 헤더에 SYN 컨트롤 비트가 1로 되어 있으면 접속 동작의 패킷이다.
    - 이 경우 접속을 접수하는 동작을 실행한다.
        - 수신처 포트 번호를 조사해서 접속 대기 상태의 소켓이 있는지 확인한다.
            - 만약 없다면 잘못 된 것으로 오류 패킷을 클라이언트에 반송한다.
        - 있으면 해당 패킷을 복사해서 새 소켓을 만들고 여기에 정보들을 기록한다.
            - 송신처 IP, 포트번호, 시퀀스 번호의 초기값, 윈도우의 값 등등
        - ACK 번호, 시퀀스 번호의 초기값, 윈도우 값등의 항목을 기록한 TCP 헤더를 만들고 IP 담당 부분에 의뢰하여 클라이언트에 반송한다.
        - 클라이언트가 잘 받았으면 ACK 번호가 돌아옴 그럼 접속 동작 끝
        - 그냥 앞에서 나온 순서 거꾸로임
- 요약
    - TCP 헤더의 SYN 컨트롤 비트를 확인
    - 수신처 포트 번호를 조사
    - 해당하는 접속 대기 소켓을 복사하여 새 소켓을 작성
    - 송신처의 IP 주소나 포트 번호 등을 기록

## TCP 담당 부분이 데이터 패킷을 수신했을 때의 동작

- 먼저 도착한 패킷이 어느 소켓에 해당하는지 조사한다.
    - IP 헤더의 송신처 주소와 수신처의 IP 주소, TCP 헤더의 수신처 포트 번호와 송신처 포트 번호 4개의 정보가 모두 합치되는 소켓을 찾는다.
- 요약
    - 도착한 패킷의 송신처 IP 주소, 송신처 포트 번호, 수신처 IP 주소, 수신처 포트 번호로부터 해당하는 소켓을 판단.
    - 데이터의 조각을 연결해서 수신 버퍼에 보관
    - 클라이언트에 ACK를 돌려줌

## TCP 담당 부분의 연결 끊기 동작

클라이언트 측과 같다.
