## Story_04 서버에서 연결을 끊어 소켓을 말소한다.
데이터 전송을 완료 한 후 동작을 알아보자!

### 데이터 전송 완료 후 연결 끊기
데이터 전송이 종료되면 클라이언트에서 연결 끊기 단계에 들어간다

데이터 보내기 완료한 쪽에서 연결 끊기 단계 들어감 (서버)<br>
-> 컨트롤 비트 FIN : 1 설정<br>

1. 클라이언트 측에서 FIN 1 의 TCP 헤더를 받고 프로토콜 스택은 서버의 연결 끊기 동작이 실행됨을 기록
2. 다시 ACK 번호를 서버측에 반송
3. 잠시후 애플리케이션이 read를 호출해 데이터를 가지러 온다.
4. 데이터를 건내기전 서버가 준 데이터를 전부 수신했다는 사실 클라이언트측에 알림
5. 데이터를 받고 클라이언트 종료
6. 클라이언트 애플리케이션 close 호출

### 소켓 말소
연결을 끊은 후 소켓을 사용해 대화를 할 수 없지만 오류를 방지하기위해 잠시 기다린 후 소켓 말소

오작동이 일어나는 이유<br>
서버에서 먼저 연결 끊기를 시작 하는 것이 아닌 클라이언트에서 시작 할 경우
1. 클라이언트 FIN 송신
2. 서버 ACK 번호 송신
3. 서버 FIN 송신
4. 클라이언트 ACK 번호 송신
   
만약 소켓이 즉각적으로 말소 된다면, 새로운 소켓에 같은 포트 번호가 할당 될 경우 그 새로운 포트는 만들어지자 마자 FIN을 수신 받게되어 오류가 발생할 수 있다.

### ⭐️전체적인 데이터 송수신 동작의 정리⭐️
#### 1. 접속
1. 클라이언트 -> 서버
  - TCP헤더에 아래항목 포함하여 전송
    - SYN = 1 포함
    - 시퀀스 번호 초기값
    - 윈도우 값
2. 서버 -> 클라이언트
   - TCP 헤더 반송
     - SYN = 1
     - 시퀀스 번호 초기값
     - ACK 번호
     - 윈도우 값
3. 클라이언트 -> 서버
   - TCP 헤더 반송
     - ACK 번호

#### 2. 송 수신
(웹 기준)<br>
1. 클라이언트 -> 서버
   - 리퀘스트 메세지 송신
     - 시퀀스 번호
     - 데이터
2. 서버 -> 클라이언트
   - 클라이언트 TCP헤더 수신 받았으므로
     - ACK 번호 반송
3. 서버 -> 클라이언트
   - 데이터 전송
     - 시퀀스 번호
     - 데이터
4. 클라이언트 -> 서버
   - ACK 번호
   - 윈도우 반송(클라이언트의 수신 버퍼에 영역이 생길 때)

#### 3. 연결 끊기
1. 서버 -> 클라이언트
   - FIN 1 을 담아 전송
2. 클라이언트 -> 서버
   - ACK 번호 반송 (수신확인)
3. 클라이언트 -> 서버
   - FIN 1 반송
4. 서버 -> 클라이언트
   - ACK 번호 송신

잠시 후 소켓 말소
