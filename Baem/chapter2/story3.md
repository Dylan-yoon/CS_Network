## Story_03 데이터를 송_수신한다.
프로토콜 스택은 바이너리 데이터가 나열되있는 것을 인식 할 뿐 어떤 데이터인지 모른다.

- MTU(Maximum Transmission Unit) : 한 패킷으로 운반할 수 있는 디지털 데이터의 최대 길이. (이더넷 에서는 1,500 byte)
- MSS(Maximum Segment Size) : MTU에서 IP, TCP 헤더를 제외한 TCP의 데이터의 최대 길이<br>
MTU = [IP 헤더][TCP 헤더][데이터]<br>
MSS =                  [데이터]

MSS 가 커질수록 송신 속도가 느려지게 되는데, 이때 프로토콜 스택 내부에 타이머가 있기에 시간 초과시 패킷을 송신한다.(나머지는 다음 패킷에 담아 넘기는 방식)

긴 패킷을 보낸다면 속도가 ⬇️ 느려지지만 네트워크 효율⬆️이 올라간다.<br>
패킷을 나누게 되면 속도는 ⬆️ 빨라지지만 네트워크 효율⬇️이 낮아진다.<br>
프로토콜 스택을 만드는 개발자에 따라 달라진다.

### 데이터가 클 때 분할
송신 버퍼에 저장된 데이터는 MSS 길이를 초과하므로 다음데이터를 기다리지 않고 크기에 맞게 분할 후 한 개씩 패킷에 넣어 송신한다.<br>
패킷을 2개로 나누게 되면 각각 TCP 헤더를 부가하고 MAC, IP 헤더를 각각 만들어 송신한다.

### 패킷을 송신한 뒤 ACK 번호를 사용해 패킷 도착 유무 확인한다.
패킷을 송신 후 TCP 에서는 올바르게 도착했는지 확인 동작으로 넘어감.

시퀀스 번호 : TCP 담당 부분은 몇 번째 바이트에 해당하는지에 대한 번호, TCP 헤더에 기록, 패킷 전체 길이에서 헤더 길이 빼면 크기계산 가능<br>
ex) 패킷이 0~1499, 1500~2897, 2898~ 4397 이 있다고 하자<br>
그렇다면 0~1499 의 패킷이 도착하고 시퀀스 번호가 1500으로 시작된다면 누락없이 데이터가 도착한 것, 하지만 2898 이 먼저 도착한다면 중간 데이터가 누락된 것임을 알 수 있다.

** TCP 는 상대가 데이터를 받은지 확인을 받을 때 까지 `버퍼 메모리` 에 패킷을 담아두기 때문에 ACK 번호가 돌아오지 않으면 패킷을 다시 보낸다.<br>
이렇기 때문에 네트워크 오류가 발생해도 오류 회복 조치를 취할 필요가 없다.<br>
하지만 여러번 시도후에도 데이터 도착 메세지를 받지 않는다면 TCP는 송신을 중단하고, 애플리케이션에 오류를 통지한다.

### 패킷의 평균 왕복 시간으로 대기시간의 조정
타임아웃 값 : ACK 번호가 돌아오는 것을 기다리는 시간<br>
대기시간
- 대기시간이 짧게 설정한다면, 네트워크의 혼잡으로 ACK번호가 돌아오는 시간이 늦어지게 될 때 불필요하게 TCP는 다시 보내게된다.
- 대기시간이 길게 설정한다면, 패킷을 다시 보내는 동작이 지연되어 속도 저하의 원인이 된다.

서버와의 거리, 정체시의 지연 등으로 대기시간을 적절하게 유지해야한다.<br>
즉 ACK 번호가 돌아오는 시간을 매번 체크해서 늘어날 때 대기시간을 늘리고, 혹은 짧게 설정해준다.

### 윈도우 제어 방식으로 효율적인 ACK 번호 관리
- 핑퐁 방식 : 데이터가 송신되고 수신확인 응답이 진행 되기 까지 다른 데이터를 송신하지 않음
  - 데이터를 하나씩 건내고 받기 때문에 수신측의 능력을 초과해 패킷을 보낼 일은 없다.
- 윈도우 방식 : 데이터를 계속적으로 송신한다.(수신 확인을 하지않고 지속적으로 보냄)
  - 수신측 능력을 초과할 우려가 있음.

능력 초과란 : 데이터를 건내는 속도보다 받는 속도가 빠르다면 수신 버퍼에 데이터가 차곡차곡 쌓여 넘쳐버리고, 넘쳐버린 데이터는 남지 않으므로 오류가 발생한 것 처럼 보이게 되는 것이다.<br>
그래서 수신측에서 송신측에 수신 가능한 데이터를 통지하여 방지한다.

ex) 
1. 수신측 -> 송신측 : 수신측이 송신측에 데이터 수용 가능 한도 공지
2. 송신측 -> 수신측 : ACK 를 받기 전까지 최대한 송신
3. 수신측 -> 송신측 : ACK 데이터받음을 통지
4. 송신측 -> 수신측 : 송신측에서 통지 받은 내용을 바탕으로 계속적으로 데이터를 적절하게 송신

윈도우 사이즈 : 수신 가능한 데이터 양의 최대값 (보통 수신측의 버퍼 메모리의 크기와 같은 크기)

### 언제 윈도우 사이즈를 송신측에 보낼 것인가? `윈도우 통지의 타이밍`
매번 ACK 번호를 보내주면서 남은 크기의 사이즈를 동시에 보낼 필요 없다.<br>
애플리케이션에서 데이터를 추출 할 때, 버퍼 메모리의 크기가 여유가 생기게 될 때 마다 송신측에 알려주면된다.<br>
`윈도우 통지의 타이밍`이다.
