## Story_05 IP와 이더넷의 패킷 송_수신 동작.
### 1. 패킷의 기본

패킷의 구성
- 헤더 : 제어 정보
- 데이터 : 데이터

TCP/IP 패킷
- 이더넷 패킷 : MAC 헤더 + IP 헤더 + TCP 헤더 + 데이터조각
- IP   패킷 : IP 헤더 + TCP 헤더 + 데이터조각

즉 MAC 헤더 + IP 패킷 = 이더넷 패킷

수신처, 송신처의 기기를 묶어서 `엔드노드`
중계 장치쪽은 `중계노드`

1. 송신처에서 패킷 목적지 ip주소를 ip헤더 수신처에 기록
2. 수신처가 어느방향인지 조사 후 그 방향의 다음 라우터 조사


1 클라이언트 -> 2 허브 -> 3 라우터 -> ... -> 2 허브 -> 3 라우터 -> 4 서버
1. 클라이언트
   - MAC 헤더에 `다음 라우터` 를 담는다.
   - IP 헤더는 목적지의 서버를 담는다. (변하지 않는다.)
   - 데이터
2. 허브에 도착한 패킷
   - MAC 헤더를 확인하고 라우터로 넘겨줌 
   - 허브가 복수일 때 허브를 순차적으로 경유하여 패킷이 진행된다.
3. 라우터
   - MAC 헤더를 수신처인 다음 라우터를 담는다.


### 2. 패킷 송수신 동작 개요
IP담당 부분은 패킷을 상대에게 송출만 한다.

패킷 송수신 동작
1. TCP 담당 부분이 IP 담당 부분이 패킷 송신을 의뢰
2. IP 담당 부분이 MAC 헤더 + IP 헤더를 덧붙인 패킷을 만들어냄
3. 패킷을 네티워크용 하드웨어(이더넷, 무선 LAN 등...)에 전달
4. 디지털 신호로 변환
5. 이 신호를 중계 장치까지 전달
6. 회답이 돌아오고 TCP헤더 + 데이터를 TCP 담당부분에 넘겨줌

### 3. 수신처 IP 주소를 기록한 IP 헤더
IP 헤더 포멧 (bit)
- 버전 : 4
- 헤더 길이 : 4
- 서비스 유형 :8 
- 전체 길이 :16 
- ID정보 : 16
- 플래그 : 3
- 프래그먼트 오프셋 : 13
- 생존기간 : 8
- 프로토콜 번호 : 8 (TCP = 06, UDP = 11, ICMP = 01 16진수)
- 헤더 체크섬 : 16
- 송신처IP주소 : 32
- 수신처IP주소 : 32
- 옵션 : 가변

가장 중요한 것은 `패킷을 어디로 전달해야 하는가 -> 수신처 IP 주소`<br>
수신처 IP 주소는 TCP 담당 부분에서부터 받아옴, 스스로 결정하는 것이 아님

`송신처 IP 주소` 컴퓨터에 할당 된 주소라기보다, LAN 어댑터에 할당.

IP용 표 = 경로표 = 라우팅 테이블

### 4 이더넷용 MAC 헤더를 만든다
이더넷에는 TCP/IC개념이 통용되지 않는다.

MAC 헤더 포멧 (bit)
- 수신처 MAC 주소 : 48 (패킷을 건내주는 상대의 MAC 주소)
- 송신처 MAC 주소 : 48 (자체 LAN 어댑터의 MAC 주소 설정)
- 이더 타입(Ether Type) : 16 -> (0800 = IP 프로토콜)

이더넷 에서는 MAC 헤더를 제외한 하위 부분을 모두 패킷 내용물로 생각함.<br>
수신처의 MAC 주소는 헤더를 만들 당시에는 알 수 없다 (송신처로부터 받아온 헤더를 기반으로 만들기 때문에)<br>
누구에게 줄 것인가는 `경로표 GateWay 항목`에 기록되어 있는 주소

### 5 ARP로 수신처 라우터의 MAC 주소를 조사
ARP : Address Resoultion Protocol<br>

연결되어 있는 모든 곳에 패킷을 전달하는 브로드 캐스트 라는 구조가 있다.

불필요 한 동작을 위해 `ARP 캐시` 에 보존<br>
시간이 되면 무조건 삭제됨, ip주소가 고쳐진 경우등 ARP 캐시 내용과 현실 사이에 일치하지 않을 수 있기 때문에<br>
보통 몇 분 정도 유효

MAC 주소를 조사할 때는 ARP를 사용

IP 담당 부분의역할은 MAC 헤더를 붙여 패킷을 완성해준다.(IP 담당 범위가 아니라 생각 할 수 있지만 이쪽이 더 좋은 방법)

MAC 주소 : 48비트(6바이트) 
- ex) 
  - 00-80-C8-2D-81-EA
  - 00:80:C8:2D:81:EA
  - 대쉬, 콜론 같은 의미 어느것을 사용해도 상관 없다.

### 6 이더넷의 기본
트렌시버 transceiver<br>
네트워크의 실체는 케이블만 있다.

트렁크 케이블 -> 리피터 허브<br>
트랜시버 케이블 -> 트위스트 페어 케이블

이더넷의 기본형
- 10BASE5(이더넷의 원형)
- 리피터 허브를 이용한 파생형
- 스위칭 허브를 이용한 형태

아래 세가지 성질을 가진 것이 이더넷 이라고 생각하면 된다.
- MAC 헤더의 수신처 MAC 주소에 기억된 상대에게 패킷 전달
- 송신처 MAC 주소로 송신처를 나타냄
- 이더 타입으로 패킷 내용물을 나타낸다

### 7 IP 패킷을 전기나 빛의 신호로 변환하여 송신한다.
##### 이더넷 패킷의 송 수신 동작

LAN 어뎁터의 제조사마다 내부 구조는 차이가 있다.<br>
LAN 어뎁터는 전원을 공급하면 즉시 사용할 수 있는 것이 아니라 초기화 작업이 필요함<br>
LAN 어뎁터의 ROM에는 전 세계적으로 중복되지 않도록 일원화해서 관리하는 MAC주소를 제조할 때 기록한다. 제조시 기록된다.

### 8 패킷에 3개의 제어용 데이터를 추가한다.
##### 패킷을 전기 신호로 변환하여 케이블에 송출<br>
LAN 드라이버는 IP 담당 부분에서 패킷을 받으면 LAN 드라이버의 버퍼 메모리에 복사.

패킷의 앞뒤로
- 앞
  - 프리앰블, 스타트 프레임 딜리미터
- 뒤
  - FCS(Frame Check Sequqence) -> 맨뒤가 11이라는 비트 패턴으로 끊나 다음이 패킷의 개시 위치로 간주
(패킷과 프레임은 같은 용어로 사용)

클록 신호<br>
아래에서 위로 변화할 때 데이터 신호의 전압이나 전류의 값을 읽고 0,1로 대응시킨다.<br>
-> 문제점 거리가 멀어지면 케이블이 길어지며 신호선의 길이가 달라져 데이터 신호와 클록 신호가 전달되는 시간에 차이가 생김

정리
1. `데이터 신호`를 보내기 위해 0, 1로 신호를 보냄
2. 문제점 발생 -> 1, 0 이 이어지면 신호 변화가 없기에 비트 구분 판단할 수 없음
3. `클록 신호`를 같이 전달해 클록신호가 아래에서 위로 변화 할 때 데이터 신호 0,1로 대응
4. 문제점 발생 -> 시간차이로 인해 클록이 틀어져버림
5. 데이터신호 + 클록신호 합성

프리엠블 -> 갑작스럽게 패킷의 신호를 흘리는 것이 아닌 클록 신호의 타이밍을 잡기 위한 특별한 신호<br>
스타트 프레임 딜리미터 -> 패킷의 시작을 나타내는 표시<br>
FCS -> 패킷운반 도중 잡음 발생으로 파형이 흐트러져 데이터 변한 경우 검출하기 위해 사용

### 9 허브를 향해 패킷 송신
*** 신호를 송신하는 동작 설명

리피터 허브(전체에  데이터 전송) -> 반이중 모드 (송 수신 동작 중 하나만 가능)<br>
스위칭 허브(해당MAC에만 데이터 전송) -> 전이중 모드 (송 수신 동작을 병행 할 수 있음)

반이중 모드, 신호충돌을 피하기 위한 동작
1. 케이블에 다른 기기가 송신한 신호가 흐르고 있는지 조사

PHY(Physical Layer Device) = MAU (Medium Attachment Unit) 

재밍 신호(잼 신호) : 이더넷에서 충돌이 발생한 경우, 알리기 위해 흘리는 특수한 신호<br>
리피터 허브, 반이중 모드의 경우 신호가 뒤섞여 충돌이 일어나면 재밍 신호를 흘려 송신 동작을 멈추고 잠시 후 다시 송신 동작 시도한다.

### 10. 돌아온 패킷을 받는다.
올바른 주소로 패킷을 전송 받고, 버퍼 메모리에 저장된다.<br>
MAC 회로가 역할을 다하면 패킷 수신 사실을 본체에 통지(인터럽트)<br>
인터럽트 구조 : 컴퓨터 본체가 LAN 어뎁터의 송 수신 동안 실행되는데, 패킷 도착 내용을 통지 받지 않으면 컴퓨터는 도착을 모르게 된다. 본체의 작업에 끼어드는 LAN 어댑터 쪽에 주의시키는 것

PnP(Plug and Play) : 확장 보드나 주변기기 등을 자동 설정하는 기능

컴퓨터는 복수의 프로그램이 동시에 작동한다.<br>
수신한 패킷은 통신을 동시에 하고있는 다른 애플리케이션의 것일지도 모르지만, <br>
LAN 드라이버는 타입 필드 값에 해당하는 프로토콜 스택에 패킷을 건네주기만 하기떄문에 해당 어플리케이션에 대응하는 패킷을 판단한다.

### 11. 서버의 응답 패킷을 IP에서 TCP로 넘긴다.
서버에서 반송된 패킷 타입 : 0800

1. 서버에서 패킷이 돌아옴
2. LAN 드라이버 -> TCP/IP 프로토콜 스택에 패킷을 건냄
3. IP 담당부분 -> IP 헤더부분 조사
   1. 오류 발생 시 IP 담당 부분의 ICMP 메세지 사용해 통신상대에 오류통지
4. 오류 없을 때, 패킷운반 도중 LAN 중에는 짧은 패킷만 다룰 수  있는 것이 있을 떄 하나의 패킷을 여러개로 분할 하는 경우 IP 담당 부분은 조각 되어있던 패킷을 원래 패킷으로 되돌린다. 분할된 패킷은 메모리에 임시보관
5. IP 헤더에 있는 ID 정보에 같은 값을 가진 패킷 도착을 기다림
   1. 분할된 패킷
      1. 프래그먼트 오프셋
      2. 리어셈블링
6. IP 담당 부분의 역할 종료 및 TCP 담당 부분에 패킷 건내줌

프래그먼트 오프셋(fragment offset) : 패킷이 원래 패킷의 어느 위치에 있었는지 나타내는 정보를 포함<br>
리어셈블링(reassembling) : 분할된 패킷이 전부 도착하기를 기다렸다가 패킷을 원래 모습대로 되돌리는 동작
